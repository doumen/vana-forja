name: "üöÄ Forja Core v6.3 Diamond"

on:
  # Permite disparar manualmente pelo GitHub
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL do V√≠do (Facebook, YT, etc)'
        required: true
      post_id:
        description: 'ID do Post no WordPress (opcional)'
        required: false

  # Permite o disparo remoto via Bot√£o no WordPress
  repository_dispatch:
    types: [forja_trigger]

jobs:
  process_hari_katha:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout do C√≥digo
        uses: actions/checkout@v3

      - name: üêç Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: üõ†Ô∏è Instalar Depend√™ncias do Sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: üì¶ Instalar Depend√™ncias Python
        run: |
          pip install yt-dlp internetarchive google-api-python-client google-auth-httplib2 google-auth-oauthlib
          pip install supabase anthropic pandas requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: "üî• Executar Forja: Stage 0 ao 2"
        env:
          # Segredos para o "Cofre" e "C√©rebro"
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          
          # Conex√£o WordPress
          WP_URL: ${{ secrets.WP_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APPLICATION_PASSWORD: ${{ secrets.WP_APPLICATION_PASSWORD }}
          
          # Preserva√ß√£o (Archive.org & Google Drive)
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
          GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

        run: |
          # Define as vari√°veis baseadas no tipo de gatilho
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            VIDEO_URL="${{ github.event.client_payload.video_url }}"
            POST_ID="${{ github.event.client_payload.post_id }}"
          else
            VIDEO_URL="${{ github.event.inputs.video_url }}"
            POST_ID="${{ github.event.inputs.post_id }}"
          fi
          
          # Lan√ßa o Maestro
          python vana_orchestrator.py --url "$VIDEO_URL" --post_id "$POST_ID"

      - name: üì∏ Upload de Frames (Artifacts)
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: golden-frames
          path: output/frames/*.jpg
          retention-days: 5